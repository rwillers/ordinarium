{% extends 'base.html' %}

{% block content %}

<div id="page">

	<h2>Plan a service</h2>

	<p>Select and arrange the ordinaries you would like to include in your service plan for the <em>{{ rite }}</em> rite. You can drag and drop the items to reorder them as needed. When you are satisfied with your selection and order, click “Generate” to create your service text.</p>

	<strong>{{ rite }}</strong>

	<form class="plan-actions" id="plan-meta-form" action="{{ url_for('main.persist_service') }}" method="post">
		<input type="hidden" name="service_id" value="{{ service_id }}">
		<input type="hidden" name="ids" value="">
		<input type="hidden" name="disabled" value="">
		<label class="plan-field">
			<span>Service title</span>
			<input type="text" name="title" value="{{ service.title or '' }}" placeholder="e.g., First Sunday of Christmas">
		</label>
		<label class="plan-field">
			<span>Service date</span>
			<input type="date" name="service_date" value="{{ service.service_date or '' }}">
		</label>
		<label class="plan-field">
			<span>Season</span>
			<input type="text" name="season" value="{{ service.season or '' }}" placeholder="e.g., Christmastide">
		</label>
		<label class="plan-field">
			<span>Occasion</span>
			<input type="text" name="occasion" value="{{ service.occasion or '' }}" placeholder="e.g., Feast of the Presentation of Christ">
		</label>
		<input type="hidden" name="rite" value="{{ service.rite or rite }}">
		<button class="plan-submit" type="submit">Save Details</button>
	</form>

	<ul class="plan-list">
	{% for ordinary in ordinaries %}
		<li class="plan-row" draggable="true">
			<div class="plan-row-main">
				<label class="plan-item">
					<input type="checkbox" name="ordinaries" value="{{ ordinary.id }}" data-default-order="{{ ordinary.default_order }}" {% if not ordinary.disabled %}checked{% endif %}>
					<span class="plan-title">{% if ordinary.detailed_title %}{{ ordinary.detailed_title }}{% else %}{{ ordinary.title }}{% endif %}</span>
					{% if ordinary.text %}<small>{{ ordinary.text | markdown_template | striptags | clean | truncate(200) }}</small>{% endif %}
				</label>
				<span class="plan-handle" aria-hidden="true">⠿</span>
			</div>
		</li>
	{% endfor %}
	</ul>

	<form class="plan-actions" id="plan-save-form" action="{{ url_for('main.persist_service') }}" method="post">
		<input type="hidden" name="service_id" value="{{ service_id }}">
		<input type="hidden" name="ids" id="plan-save-ids" value="">
		<input type="hidden" name="disabled" id="plan-save-disabled" value="">
		<button class="plan-submit" type="submit">Save</button>
	</form>

	<form class="plan-actions" id="plan-form" action="{{ url_for('main.text', rite_slug=rite_slug) }}" method="get">
		<input type="hidden" name="ids" id="plan-ids" value="">
		<button class="plan-submit" type="submit">Generate</button>
	</form>

	<script>
		const planList = document.querySelector('.plan-list')
		const planForm = document.querySelector('#plan-form')
		const planIds = document.querySelector('#plan-ids')
		const planSaveForm = document.querySelector('#plan-save-form')
		const planSaveIds = document.querySelector('#plan-save-ids')
		const planSaveDisabled = document.querySelector('#plan-save-disabled')
		const planMetaForm = document.querySelector('#plan-meta-form')
		let draggedRow = null

		const collectIds = () => {
			if (!planList) {
				return []
			}
			return Array.from(planList.querySelectorAll('.plan-row input[type="checkbox"]'))
				.filter((input) => input.checked)
				.map((input) => input.value)
		}

		if (planForm) {
			planForm.addEventListener('submit', () => {
				if (!planIds) {
					return
				}
				planIds.value = collectIds().join(',')
			})
		}

		if (planSaveForm) {
			planSaveForm.addEventListener('submit', () => {
				if (!planSaveIds || !planSaveDisabled) {
					return
				}
				const inputs = Array.from(planList.querySelectorAll('.plan-row input[type="checkbox"]'))
				planSaveIds.value = inputs.map((input) => input.value).join(',')
				planSaveDisabled.value = inputs
					.filter((input) => !input.checked)
					.map((input) => input.value)
					.join(',')
			})
		}

		if (planList) {
			planList.addEventListener('dragstart', (event) => {
				const row = event.target.closest('.plan-row')
				if (!row) {
					return
				}
				draggedRow = row
				event.dataTransfer.effectAllowed = 'move'
				event.dataTransfer.setData('text/plain', '')
				row.classList.add('is-dragging')
			})

			planList.addEventListener('dragend', (event) => {
				const row = event.target.closest('.plan-row')
				if (row) {
					row.classList.remove('is-dragging')
				}
				draggedRow = null
			})

			planList.addEventListener('dragover', (event) => {
				event.preventDefault()
				const target = event.target.closest('.plan-row')
				if (!target || target === draggedRow) {
					return
				}
				const rect = target.getBoundingClientRect()
				const insertAfter = event.clientY - rect.top > rect.height / 2
				planList.insertBefore(draggedRow, insertAfter ? target.nextSibling : target)
			})
		}

		if (planMetaForm) {
			planMetaForm.addEventListener('submit', () => {
				const ids = planMetaForm.querySelector('input[name="ids"]')
				const disabled = planMetaForm.querySelector('input[name="disabled"]')
				if (!ids || !disabled) {
					return
				}
				const inputs = Array.from(planList.querySelectorAll('.plan-row input[type="checkbox"]'))
				ids.value = inputs.map((input) => input.value).join(',')
				disabled.value = inputs
					.filter((input) => !input.checked)
					.map((input) => input.value)
					.join(',')
			})
		}
	</script>

</div>

{% endblock %}
