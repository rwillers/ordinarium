{% extends 'base.html' %}

{% block content %}

<div id="page" class="plan-page">

		<div class="plan-header">
			<div class="plan-header-actions-fixed">
				<div class="plan-header-actions">
					<div class="plan-header-buttons">
						<a class="button" id="plan-view-link" href="{{ url_for('main.text', service_id=service_id) }}">View</a>
						{% if can_share %}
						<button class="plan-submit" type="button" data-share-url="{{ url_for('main.service_share', service_id=service_id) }}">Share</button>
						{% endif %}
						{% if can_delete %}
						<form action="{{ url_for('main.service_delete', service_id=service_id) }}" method="post" onsubmit="return confirm('Delete this service? This cannot be undone.')">
							<button class="plan-submit" type="submit">Delete</button>
						</form>
						{% endif %}
					</div>
					<div class="plan-header-status">
						<span class="plan-save-status" id="plan-save-status" aria-live="polite"></span>
					</div>
				</div>
			</div>
		</div>
	<h2 class="plan-title">Plan a service</h2>
	<div class="share-modal" id="share-modal" aria-hidden="true">
		<div class="share-modal-backdrop" data-share-close></div>
		<div class="share-modal-card" role="dialog" aria-modal="true" aria-labelledby="share-modal-title">
			<h3 id="share-modal-title">Share link</h3>
			<p>Anyone with this link can view the service text, and changes you make will appear automatically.</p>
			<div class="share-modal-link">
				<input type="text" id="share-modal-url" readonly>
				<button type="button" class="plan-submit" id="share-copy-button">Copy</button>
			</div>
			<p class="share-modal-feedback" id="share-copy-feedback" aria-live="polite"></p>
			<div class="share-modal-actions">
				<button type="button" class="plan-submit" data-share-close>Close</button>
			</div>
		</div>
	</div>
	<p>Select and arrange the ordinaries you would like to include in your service plan for the <em>{{ rite }}</em> rite. You can drag and drop the items to reorder them as needed. When you are satisfied with your selection and order, click “View” to see your service text.</p>

	<strong>{{ rite }}</strong>

	<form class="plan-actions" id="plan-meta-form" action="{{ url_for('main.persist_service') }}" method="post">
		<input type="hidden" name="service_id" value="{{ service_id }}">
		<input type="hidden" name="ids" value="">
		<input type="hidden" name="disabled" value="">
		<p><label class="plan-field">
			<span>Service date:</span>
			<input type="date" name="service_date" id="plan-service-date" value="{{ service.service_date or '' }}" required>
		</label></p>
		<p class="plan-save-error" id="plan-save-error" aria-live="polite"></p>
		<div class="plan-inline-fields">
			<p id="plan-season-row"{% if not service.service_date %} style="display: none;"{% endif %}>
				<label class="plan-field">
					<span>Season:</span>
					<strong class="plan-field-value" id="plan-season-display">{{ service.season or 'Auto-detect' }}</strong>
				</label>
			</p>
			<p id="plan-observance-row"{% if not observance_options %} style="display: none;"{% endif %}>
				<label class="plan-field">
					<span>Observance:</span>
					<strong class="plan-field-value" id="plan-observance-display"{% if observance_options and observance_options|length > 1 %} style="display: none;"{% endif %}>
						{{ observance_title or 'Auto-detect' }}
					</strong>
					<select id="plan-observance-select" name="observance_handle"{% if not observance_options or observance_options|length == 1 %} style="display: none;"{% endif %}>
						{% for option in observance_options %}
						<option value="{{ option.handle }}"{% if option.selected %} selected{% endif %}>{{ option.title }}{% if option.is_default %} (default){% endif %}</option>
						{% endfor %}
					</select>
				</label>
			</p>
		</div>
		<input type="hidden" name="rite" value="{{ service.rite or rite }}">
	</form>

	<ul class="plan-list">
	{% for ordinary in ordinaries %}
		<li class="plan-row" data-plan-token="{{ ordinary.token }}"{% if ordinary.type == 'custom' %} data-custom-title="{{ ordinary.title | e }}" data-custom-text="{{ ordinary.text | e }}" data-custom-id="{{ ordinary.id }}"{% endif %} draggable="true">
			<div class="plan-row-main">
				<label class="plan-item">
					<input type="checkbox" name="ordinaries" value="{{ ordinary.token }}"{% if ordinary.default_order is not none %} data-default-order="{{ ordinary.default_order }}"{% endif %} {% if not ordinary.disabled %}checked{% endif %}>
					<span class="plan-title">{% if ordinary.detailed_title %}{{ ordinary.detailed_title }}{% else %}{{ ordinary.title }}{% endif %}</span>
					{% if ordinary.text %}<small>{{ ordinary.text | markdown_template | striptags | clean | truncate(200) }}</small>{% endif %}
				</label>
				<span class="plan-handle" aria-hidden="true">⠿</span>
			</div>
			<div class="plan-row-menu" data-row-menu>
				<button class="plan-icon-button plan-menu-toggle" type="button" data-row-menu-toggle aria-expanded="false" aria-haspopup="true" aria-label="Row actions">▾</button>
				<div class="plan-row-menu-panel" role="menu">
					{% if ordinary.type == 'custom' %}
					<button class="plan-row-menu-item" type="button" data-custom-edit role="menuitem"><span class="plan-row-menu-icon" aria-hidden="true">✎</span>Edit</button>
					<form action="{{ url_for('main.service_delete_custom_element', service_id=service_id, custom_id=ordinary.id) }}" method="post" onsubmit="return confirm('Remove this custom element from the service plan?')">
						<button class="plan-row-menu-item plan-row-menu-delete" type="submit" role="menuitem"><span class="plan-row-menu-icon" aria-hidden="true">✕</span>Delete</button>
					</form>
					{% endif %}
					<button class="plan-row-menu-item" type="button" data-custom-add role="menuitem"><span class="plan-row-menu-icon" aria-hidden="true">＋</span>Add new</button>
				</div>
			</div>
		</li>
	{% endfor %}
	</ul>
	<div class="share-modal" id="custom-element-modal" aria-hidden="true">
		<div class="share-modal-backdrop" data-custom-element-close></div>
		<div class="share-modal-card" role="dialog" aria-modal="true" aria-labelledby="custom-element-title">
			<h3 id="custom-element-title">Add custom element</h3>
			<form class="plan-custom-form" action="{{ url_for('main.service_add_custom_element', service_id=service_id) }}" method="post">
				<input type="hidden" name="service_id" value="{{ service_id }}">
				<input type="hidden" name="rite" value="{{ service.rite or rite }}">
				<input type="hidden" name="custom_id" value="">
				<input type="hidden" name="insert_after" value="">
				<input type="hidden" name="initial_title" value="">
				<input type="hidden" name="initial_text" value="">
				<p>
					<label class="plan-field">
						<span>Apply template</span>
						<select id="custom-template-select">
							<option value="">Choose a template</option>
							{% if custom_templates %}
								{% for template in custom_templates %}
								<option value="{{ template.id }}" data-template-title="{{ template.title | e }}" data-template-text="{{ template.text | e }}">{{ template.title }}</option>
								{% endfor %}
							{% else %}
								<option value="" disabled>No templates available</option>
							{% endif %}
						</select>
					</label>
				</p>
				<p>
					<label class="plan-field">
						<span>Title</span>
						<input type="text" name="title" required>
					</label>
				</p>
				<p>
					<label class="plan-field">
						<span>Text</span>
						<textarea name="text" rows="6"></textarea>
					</label>
				</p>
				<div class="plan-custom-actions">
					<button class="plan-submit" type="button" data-custom-element-close>Cancel</button>
					<button class="plan-submit" type="submit">Save</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		const shareButton = document.querySelector('[data-share-url]')
		const shareModal = document.querySelector('#share-modal')
		const shareModalUrl = document.querySelector('#share-modal-url')
		const shareCopyButton = document.querySelector('#share-copy-button')
		const shareCopyFeedback = document.querySelector('#share-copy-feedback')

		const openShareModal = (url) => {
			if (!shareModal || !shareModalUrl) {
				return
			}
			shareModalUrl.value = url
			if (shareCopyFeedback) {
				shareCopyFeedback.textContent = ''
			}
			shareModal.setAttribute('aria-hidden', 'false')
			document.body.classList.add('is-modal-open')
			shareModalUrl.select()
		}

		const closeShareModal = () => {
			if (!shareModal) {
				return
			}
			shareModal.setAttribute('aria-hidden', 'true')
			document.body.classList.remove('is-modal-open')
		}

		if (shareButton) {
			shareButton.addEventListener('click', async () => {
				const shareUrl = shareButton.getAttribute('data-share-url')
				if (!shareUrl) {
					return
				}
				try {
					const response = await fetch(shareUrl, { method: 'POST' })
					if (!response.ok) {
						return
					}
					const data = await response.json()
					if (data && data.share_url) {
						openShareModal(data.share_url)
					}
				} catch (error) {
					// Ignore share failures.
				}
			})
		}

		if (shareModal) {
			shareModal.addEventListener('click', (event) => {
				if (event.target && event.target.matches('[data-share-close]')) {
					closeShareModal()
				}
			})
		}

		if (shareCopyButton && shareModalUrl) {
			shareCopyButton.addEventListener('click', async () => {
				let copied = false
				try {
					await navigator.clipboard.writeText(shareModalUrl.value)
					copied = true
				} catch (error) {
					shareModalUrl.select()
					document.execCommand('copy')
					copied = true
				}
				if (shareCopyFeedback) {
					shareCopyFeedback.textContent = copied ? 'Link copied.' : 'Unable to copy link.'
				}
			})
		}

		document.addEventListener('keydown', (event) => {
			if (event.key === 'Escape' && shareModal && shareModal.getAttribute('aria-hidden') === 'false') {
				closeShareModal()
			}
		})

		const planList = document.querySelector('.plan-list')
		const planMetaForm = document.querySelector('#plan-meta-form')
		const planServiceDate = document.querySelector('#plan-service-date')
		const planSeasonDisplay = document.querySelector('#plan-season-display')
		const planSeasonRow = document.querySelector('#plan-season-row')
		const planObservanceRow = document.querySelector('#plan-observance-row')
		const planObservanceDisplay = document.querySelector('#plan-observance-display')
		const planObservanceSelect = document.querySelector('#plan-observance-select')
		const planSaveStatus = document.querySelector('#plan-save-status')
		const planSaveError = document.querySelector('#plan-save-error')
		let draggedRow = null

		const updatePlanInputs = () => {
			if (!planMetaForm || !planList) {
				return false
			}
			const ids = planMetaForm.querySelector('input[name="ids"]')
			const disabled = planMetaForm.querySelector('input[name="disabled"]')
			if (!ids || !disabled) {
				return false
			}
			const inputs = Array.from(
				planList.querySelectorAll('.plan-row input[type="checkbox"]')
			)
			ids.value = inputs.map((input) => input.value).join(',')
			disabled.value = inputs
				.filter((input) => !input.checked)
				.map((input) => input.value)
				.join(',')
			return true
		}

		const setSaveStatus = (message, variant = '') => {
			if (!planSaveStatus) {
				return
			}
			planSaveStatus.textContent = message
			planSaveStatus.style.display = message ? 'inline-flex' : 'none'
			planSaveStatus.dataset.status = variant
		}

		const setSaveError = (message) => {
			if (!planSaveError) {
				return
			}
			planSaveError.textContent = message
			planSaveError.style.display = message ? 'block' : 'none'
		}

		let autosaveTimer = null
		let autosaveInFlight = false
		let autosaveQueued = false

		const runAutosave = async () => {
			if (!planMetaForm) {
				return true
			}
			if (!planServiceDate || !planServiceDate.value) {
				setSaveError('Service date is required before changes can be saved.')
				setSaveStatus('Not saved', 'error')
				return false
			}
			setSaveError('')
			updatePlanInputs()
			const formData = new FormData(planMetaForm)
			formData.set('autosave', '1')
			setSaveStatus('Saving...', 'saving')
			try {
				const response = await fetch(planMetaForm.action, {
					method: 'POST',
					body: formData,
					headers: {
						Accept: 'application/json'
					}
				})
				if (!response.ok) {
					const data = await response.json().catch(() => null)
					const message = data?.error || 'Unable to save changes.'
					setSaveError(message)
					setSaveStatus('Not saved', 'error')
					return false
				}
				setSaveStatus('Saved', 'saved')
				return true
			} catch (error) {
				setSaveError('Unable to save changes.')
				setSaveStatus('Not saved', 'error')
				return false
			}
		}

		const scheduleAutosave = (delay = 700) => {
			autosaveQueued = true
			if (autosaveInFlight) {
				return
			}
			if (autosaveTimer) {
				clearTimeout(autosaveTimer)
			}
			autosaveTimer = setTimeout(async () => {
				if (autosaveInFlight) {
					return
				}
				autosaveInFlight = true
				autosaveQueued = false
				try {
					await runAutosave()
				} finally {
					autosaveInFlight = false
					if (autosaveQueued) {
						scheduleAutosave()
					}
				}
			}, delay)
		}

		if (planServiceDate && planServiceDate.value) {
			setSaveStatus('Saved', 'saved')
		}

		if (planList) {
			planList.addEventListener('dragstart', (event) => {
				const row = event.target.closest('.plan-row')
				if (!row) {
					return
				}
				draggedRow = row
				event.dataTransfer.effectAllowed = 'move'
				event.dataTransfer.setData('text/plain', '')
				row.classList.add('is-dragging')
			})

			planList.addEventListener('dragend', (event) => {
				const row = event.target.closest('.plan-row')
				if (row) {
					row.classList.remove('is-dragging')
				}
				draggedRow = null
				scheduleAutosave()
			})

			planList.addEventListener('dragover', (event) => {
				event.preventDefault()
				const target = event.target.closest('.plan-row')
				if (!target || target === draggedRow) {
					return
				}
				const rect = target.getBoundingClientRect()
				const insertAfter = event.clientY - rect.top > rect.height / 2
				planList.insertBefore(draggedRow, insertAfter ? target.nextSibling : target)
			})

			planList.addEventListener('change', (event) => {
				if (event.target && event.target.matches('input[type="checkbox"]')) {
					scheduleAutosave()
				}
			})
		}

		if (planMetaForm) {
			planMetaForm.addEventListener('submit', (event) => {
				event.preventDefault()
				scheduleAutosave(0)
			})
		}

		if (planServiceDate && planSeasonDisplay) {
			const updateObservanceFromDate = async () => {
				if (!planServiceDate.value) {
					planSeasonDisplay.textContent = 'Auto-detect'
					if (planSeasonRow) {
						planSeasonRow.style.display = 'none'
					}
					if (planObservanceRow) {
						planObservanceRow.style.display = 'none'
					}
					return
				}
				try {
					const response = await fetch(`/observance?date=${planServiceDate.value}`)
					if (!response.ok) {
						return
					}
					const data = await response.json()
					if (data && data.season) {
						planSeasonDisplay.textContent = data.season
					}
					if (planSeasonRow) {
						planSeasonRow.style.display = ''
					}
					if (planObservanceRow) {
						const options = Array.isArray(data?.options) ? data.options : []
						const hasOptions = options.length > 0
						planObservanceRow.style.display = hasOptions ? '' : 'none'
						if (hasOptions && planObservanceSelect) {
							const currentValue = planObservanceSelect.value
							planObservanceSelect.innerHTML = ''
							options.forEach((option, index) => {
								const optionEl = document.createElement('option')
								optionEl.value = option.handle
								optionEl.textContent = option.title + (index === 0 ? ' (default)' : '')
								planObservanceSelect.appendChild(optionEl)
							})
							const stillValid = options.some((option) => option.handle === currentValue)
							const selectedHandle = stillValid
								? currentValue
								: data.default_handle || options[0].handle
							if (selectedHandle) {
								planObservanceSelect.value = selectedHandle
							}
							planObservanceSelect.style.display = options.length > 1 ? '' : 'none'
						}
						if (planObservanceDisplay) {
							planObservanceDisplay.textContent = data.title || 'Auto-detect'
							planObservanceDisplay.style.display = options.length > 1 ? 'none' : ''
						}
					}
				} catch (error) {
					// Ignore lookup failures.
				}
			}

			planServiceDate.addEventListener('change', () => {
				updateObservanceFromDate()
				scheduleAutosave()
			})
			if (planServiceDate.value) {
				updateObservanceFromDate()
			}
		}

		if (planObservanceSelect) {
			planObservanceSelect.addEventListener('change', () => {
				scheduleAutosave()
			})
		}

		const customModal = document.querySelector('#custom-element-modal')
		const customEditButtons = document.querySelectorAll('[data-custom-edit]')
		const customAddButtons = document.querySelectorAll('[data-custom-add]')
		const templateSelect = document.querySelector('#custom-template-select')
		const rowMenus = document.querySelectorAll('[data-row-menu]')
		const rowMenuToggles = document.querySelectorAll('[data-row-menu-toggle]')

		const closeRowMenus = (exceptMenu = null) => {
			rowMenus.forEach((menu) => {
				if (menu === exceptMenu) {
					return
				}
				menu.classList.remove('is-open')
				const toggle = menu.querySelector('[data-row-menu-toggle]')
				if (toggle) {
					toggle.setAttribute('aria-expanded', 'false')
				}
				const row = menu.closest('.plan-row')
				if (row) {
					row.classList.remove('is-menu-open')
				}
			})
		}

		if (rowMenuToggles.length) {
			rowMenuToggles.forEach((toggle) => {
				toggle.addEventListener('click', (event) => {
					event.stopPropagation()
					const menu = toggle.closest('[data-row-menu]')
					if (!menu) {
						return
					}
					const isOpen = !menu.classList.contains('is-open')
					closeRowMenus(menu)
					menu.classList.toggle('is-open', isOpen)
					toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false')
					const row = menu.closest('.plan-row')
					if (row) {
						row.classList.toggle('is-menu-open', isOpen)
					}
				})
			})
		}

		document.addEventListener('click', (event) => {
			if (!event.target.closest('[data-row-menu]')) {
				closeRowMenus()
			}
		})

		const openCustomModal = (mode) => {
			if (!customModal) {
				return
			}
			const form = customModal.querySelector('form')
			const titleInput = form?.querySelector('input[name="title"]')
			const textInput = form?.querySelector('textarea[name="text"]')
			const idInput = form?.querySelector('input[name="custom_id"]')
			const insertAfterInput = form?.querySelector('input[name="insert_after"]')
			const modalTitle = customModal.querySelector('#custom-element-title')
			const initialTitleInput = form?.querySelector('input[name="initial_title"]')
			const initialTextInput = form?.querySelector('input[name="initial_text"]')
			if (templateSelect) {
				templateSelect.value = ''
			}
			if (mode?.type === 'edit') {
				if (titleInput) {
					titleInput.value = mode.title || ''
				}
				if (textInput) {
					textInput.value = mode.text || ''
				}
				if (idInput) {
					idInput.value = mode.id || ''
				}
				if (insertAfterInput) {
					insertAfterInput.value = ''
				}
				if (initialTitleInput) {
					initialTitleInput.value = mode.title || ''
				}
				if (initialTextInput) {
					initialTextInput.value = mode.text || ''
				}
				if (modalTitle) {
					modalTitle.textContent = 'Edit custom element'
				}
				customModal.dataset.mode = 'edit'
			} else {
				if (titleInput) {
					titleInput.value = ''
				}
				if (textInput) {
					textInput.value = ''
				}
				if (idInput) {
					idInput.value = ''
				}
				if (insertAfterInput) {
					insertAfterInput.value = mode?.insertAfter || ''
				}
				if (initialTitleInput) {
					initialTitleInput.value = ''
				}
				if (initialTextInput) {
					initialTextInput.value = ''
				}
				if (modalTitle) {
					modalTitle.textContent = 'Add custom element'
				}
				customModal.dataset.mode = 'add'
			}
			customModal.setAttribute('aria-hidden', 'false')
			document.body.classList.add('is-modal-open')
			if (titleInput) {
				titleInput.focus()
			}
		}

		const closeCustomModal = () => {
			if (!customModal) {
				return
			}
			customModal.setAttribute('aria-hidden', 'true')
			document.body.classList.remove('is-modal-open')
			customModal.dataset.mode = ''
		}

		if (customEditButtons.length) {
			customEditButtons.forEach((button) => {
				button.addEventListener('click', () => {
					const row = button.closest('.plan-row')
					if (!row) {
						return
					}
					closeRowMenus()
					openCustomModal({
						type: 'edit',
						id: row.getAttribute('data-custom-id'),
						title: row.getAttribute('data-custom-title'),
						text: row.getAttribute('data-custom-text')
					})
				})
			})
		}

		if (customAddButtons.length) {
			customAddButtons.forEach((button) => {
				button.addEventListener('click', () => {
					const row = button.closest('.plan-row')
					if (!row) {
						return
					}
					closeRowMenus()
					openCustomModal({
						type: 'add',
						insertAfter: row.getAttribute('data-plan-token')
					})
				})
			})
		}

		if (customModal) {
			customModal.addEventListener('click', (event) => {
				if (event.target && event.target.matches('[data-custom-element-close]')) {
					const form = customModal.querySelector('form')
					const titleInput = form?.querySelector('input[name="title"]')
					const textInput = form?.querySelector('textarea[name="text"]')
					const insertAfterInput = form?.querySelector('input[name="insert_after"]')
					const initialTitleInput = form?.querySelector('input[name="initial_title"]')
					const initialTextInput = form?.querySelector('input[name="initial_text"]')
					const currentTitle = titleInput ? titleInput.value.trim() : ''
					const currentText = textInput ? textInput.value.trim() : ''
					const initialTitle = initialTitleInput ? initialTitleInput.value : ''
					const initialText = initialTextInput ? initialTextInput.value : ''
					const hasChanges = currentTitle !== initialTitle || currentText !== initialText
					if (hasChanges) {
						const confirmed = window.confirm('Discard this custom element? Your changes will be lost.')
						if (!confirmed) {
							return
						}
					}
					if (titleInput) {
						titleInput.value = ''
					}
					if (textInput) {
						textInput.value = ''
					}
					if (insertAfterInput) {
						insertAfterInput.value = ''
					}
					if (templateSelect) {
						templateSelect.value = ''
					}
					if (initialTitleInput) {
						initialTitleInput.value = ''
					}
					if (initialTextInput) {
						initialTextInput.value = ''
					}
					closeCustomModal()
				}
			})
		}

		if (templateSelect) {
			templateSelect.addEventListener('change', () => {
				const selectedOption = templateSelect.options[templateSelect.selectedIndex]
				if (!selectedOption) {
					return
				}
				const templateTitle = selectedOption.getAttribute('data-template-title')
				const templateText = selectedOption.getAttribute('data-template-text')
				if (templateTitle === null && templateText === null) {
					return
				}
				const form = customModal?.querySelector('form')
				const titleInput = form?.querySelector('input[name="title"]')
				const textInput = form?.querySelector('textarea[name="text"]')
				if (titleInput && templateTitle !== null) {
					titleInput.value = templateTitle
				}
				if (textInput && templateText !== null) {
					textInput.value = templateText
				}
			})
		}

		const truncateText = (text, limit = 200) => {
			if (!text || text.length <= limit) {
				return text
			}
			return text.slice(0, limit - 1) + '…'
		}

		const updateCustomRow = (customId, title, text) => {
			if (!customId) {
				return
			}
			const row = document.querySelector(`.plan-row[data-custom-id="${customId}"]`)
			if (!row) {
				return
			}
			if (title !== undefined) {
				row.setAttribute('data-custom-title', title)
				const titleEl = row.querySelector('.plan-title')
				if (titleEl) {
					titleEl.textContent = title
				}
			}
			if (text !== undefined) {
				row.setAttribute('data-custom-text', text)
				const textEl = row.querySelector('small')
				if (textEl) {
					textEl.textContent = truncateText(text)
				}
			}
		}

		let customAutosaveTimer = null
		let customAutosaveInFlight = false
		let customAutosaveQueued = false

		const scheduleCustomAutosave = (delay = 900) => {
			customAutosaveQueued = true
			if (customAutosaveInFlight) {
				return
			}
			if (customAutosaveTimer) {
				clearTimeout(customAutosaveTimer)
			}
			customAutosaveTimer = setTimeout(async () => {
				if (customAutosaveInFlight) {
					return
				}
				customAutosaveInFlight = true
				customAutosaveQueued = false
				try {
					await runCustomAutosave()
				} finally {
					customAutosaveInFlight = false
					if (customAutosaveQueued) {
						scheduleCustomAutosave()
					}
				}
			}, delay)
		}

		const runCustomAutosave = async () => {
			if (!customModal || customModal.dataset.mode !== 'edit') {
				return
			}
			const form = customModal.querySelector('form')
			if (!form) {
				return
			}
			const customId = form.querySelector('input[name="custom_id"]')?.value
			if (!customId) {
				return
			}
			const titleValue = form.querySelector('input[name="title"]')?.value?.trim()
			const textValue = form.querySelector('textarea[name="text"]')?.value || ''
			const initialTitleInput = form.querySelector('input[name="initial_title"]')
			const initialTextInput = form.querySelector('input[name="initial_text"]')
			if (!titleValue) {
				return
			}
			const formData = new FormData(form)
			formData.set('autosave', '1')
			try {
				const response = await fetch(form.action, {
					method: 'POST',
					body: formData,
					headers: {
						Accept: 'application/json'
					}
				})
				if (!response.ok) {
					return
				}
				const data = await response.json().catch(() => null)
				if (data?.custom_id) {
					updateCustomRow(data.custom_id, data.title, data.text)
					if (initialTitleInput) {
						initialTitleInput.value = titleValue
					}
					if (initialTextInput) {
						initialTextInput.value = textValue
					}
				}
			} catch (error) {
				// Ignore autosave errors for custom elements.
			}
		}

		if (customModal) {
			customModal.addEventListener('input', (event) => {
				if (!event.target.closest('input[name="title"], textarea[name="text"]')) {
					return
				}
				scheduleCustomAutosave()
			})
		}

		document.addEventListener('keydown', (event) => {
			if (event.key === 'Escape' && customModal && customModal.getAttribute('aria-hidden') === 'false') {
				closeCustomModal()
			}
		})

		document.addEventListener('keydown', (event) => {
			if (event.key === 'Escape') {
				closeRowMenus()
			}
		})
	</script>

</div>

{% endblock %}
