{% extends 'base.html' %}

{% block content %}

<div id="page">

	<div class="plan-header">
		<h2>Plan a service</h2>
		<div class="plan-header-actions">
			<button class="plan-submit" type="submit" form="plan-meta-form">Save</button>
			<button class="plan-submit" type="submit" form="plan-meta-form" name="action" value="generate">Generate</button>
			{% if can_delete %}
			<form action="{{ url_for('main.service_delete', service_id=service_id) }}" method="post" onsubmit="return confirm('Delete this service? This cannot be undone.')">
				<button class="plan-submit" type="submit">Delete</button>
			</form>
			{% endif %}
		</div>
	</div>
	{% if form_error %}
	<p class="plan-error">{{ form_error }}</p>
	{% endif %}

	<p>Select and arrange the ordinaries you would like to include in your service plan for the <em>{{ rite }}</em> rite. You can drag and drop the items to reorder them as needed. When you are satisfied with your selection and order, click “Generate” to create your service text.</p>

	<strong>{{ rite }}</strong>

	<form class="plan-actions" id="plan-meta-form" action="{{ url_for('main.persist_service') }}" method="post">
		<input type="hidden" name="service_id" value="{{ service_id }}">
		<input type="hidden" name="ids" value="">
		<input type="hidden" name="disabled" value="">
		<p><label class="plan-field">
			<span>Service title:</span>
			<input type="text" name="title" value="{{ service.title or '' }}" placeholder="e.g., First Sunday of Christmas" required>
		</label></p>
		<p><label class="plan-field">
			<span>Service date:</span>
			<input type="date" name="service_date" id="plan-service-date" value="{{ service.service_date or '' }}" required>
		</label></p>
		<p><label class="plan-field">
			<span>Season:</span>
			<strong class="plan-field-value" id="plan-season-display">{{ service.season or 'Auto-detect' }}</strong>
		</label></p>
		<input type="hidden" name="rite" value="{{ service.rite or rite }}">
	</form>

	<ul class="plan-list">
	{% for ordinary in ordinaries %}
		<li class="plan-row" draggable="true">
			<div class="plan-row-main">
				<label class="plan-item">
					<input type="checkbox" name="ordinaries" value="{{ ordinary.id }}" data-default-order="{{ ordinary.default_order }}" {% if not ordinary.disabled %}checked{% endif %}>
					<span class="plan-title">{% if ordinary.detailed_title %}{{ ordinary.detailed_title }}{% else %}{{ ordinary.title }}{% endif %}</span>
					{% if ordinary.text %}<small>{{ ordinary.text | markdown_template | striptags | clean | truncate(200) }}</small>{% endif %}
				</label>
				<span class="plan-handle" aria-hidden="true">⠿</span>
			</div>
		</li>
	{% endfor %}
	</ul>

	<script>
		const planList = document.querySelector('.plan-list')
		const planMetaForm = document.querySelector('#plan-meta-form')
		const planServiceDate = document.querySelector('#plan-service-date')
		const planSeasonDisplay = document.querySelector('#plan-season-display')
		let draggedRow = null

		if (planList) {
			planList.addEventListener('dragstart', (event) => {
				const row = event.target.closest('.plan-row')
				if (!row) {
					return
				}
				draggedRow = row
				event.dataTransfer.effectAllowed = 'move'
				event.dataTransfer.setData('text/plain', '')
				row.classList.add('is-dragging')
			})

			planList.addEventListener('dragend', (event) => {
				const row = event.target.closest('.plan-row')
				if (row) {
					row.classList.remove('is-dragging')
				}
				draggedRow = null
			})

			planList.addEventListener('dragover', (event) => {
				event.preventDefault()
				const target = event.target.closest('.plan-row')
				if (!target || target === draggedRow) {
					return
				}
				const rect = target.getBoundingClientRect()
				const insertAfter = event.clientY - rect.top > rect.height / 2
				planList.insertBefore(draggedRow, insertAfter ? target.nextSibling : target)
			})
		}

		if (planMetaForm) {
			planMetaForm.addEventListener('submit', () => {
				const ids = planMetaForm.querySelector('input[name="ids"]')
				const disabled = planMetaForm.querySelector('input[name="disabled"]')
				if (!ids || !disabled) {
					return
				}
				const inputs = Array.from(
					planList.querySelectorAll('.plan-row input[type="checkbox"]')
				)
				ids.value = inputs.map((input) => input.value).join(',')
				disabled.value = inputs
					.filter((input) => !input.checked)
					.map((input) => input.value)
					.join(',')
			})
		}

		if (planServiceDate && planSeasonDisplay) {
			const updateSeasonFromDate = async () => {
				if (!planServiceDate.value) {
					planSeasonDisplay.textContent = 'Auto-detect'
					return
				}
				try {
					const response = await fetch(`/season?date=${planServiceDate.value}`)
					if (!response.ok) {
						return
					}
					const data = await response.json()
					if (data && data.season) {
						planSeasonDisplay.textContent = data.season
					}
				} catch (error) {
					// Ignore lookup failures.
				}
			}

			planServiceDate.addEventListener('change', updateSeasonFromDate)
			if (planServiceDate.value) {
				updateSeasonFromDate()
			}
		}
	</script>

</div>

{% endblock %}
